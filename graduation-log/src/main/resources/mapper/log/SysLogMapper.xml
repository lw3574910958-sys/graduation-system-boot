<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lw.graduation.infrastructure.mapper.log.SysLogMapper">

    <!-- 继承通用Mapper的基础配置 -->
    <resultMap id="BaseResultMap" type="com.lw.graduation.domain.entity.log.SysLog">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="username" property="username" />
        <result column="user_type" property="userType" />
        <result column="module" property="module" />
        <result column="operation" property="operation" />
        <result column="business_id" property="businessId" />
        <result column="status" property="status" />
        <result column="ip_address" property="ipAddress" />
        <result column="duration_ms" property="durationMs" />
        <result column="error_message" property="errorMessage" />
        <result column="created_at" property="createdAt" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, user_id, username, user_type, module, operation, business_id, status, ip_address, duration_ms, error_message, created_at
    </sql>
    
    <!-- 实现通用批量查询详情及关联信息 -->
    <select id="selectDetailsWithRelations" resultType="map">
        SELECT 
            l.id,
            l.user_id,
            l.username,
            l.user_type,
            l.module,
            l.operation,
            l.business_id,
            l.status,
            l.ip_address,
            l.duration_ms,
            l.error_message,
            l.created_at,
            u.real_name as user_real_name
        FROM sys_log l
        LEFT JOIN sys_user u ON l.user_id = u.id
        WHERE l.id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    
    <!-- 实现增强版批量查询 -->
    <select id="selectBatchWithOrder" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List" />
        FROM sys_log
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY FIELD(id, 
        <foreach collection="ids" item="id" separator=",">
            #{id}
        </foreach>
        )
    </select>
    
    <!-- 实现通用统计方法 -->
    <select id="selectStatistics" resultType="map">
        SELECT 
            COUNT(*) as total_count,
            AVG(duration_ms) as avg_duration,
            MAX(duration_ms) as max_duration,
            MIN(duration_ms) as min_duration
        FROM sys_log
        WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        <if test="condition.module != null">
            AND module = #{condition.module}
        </if>
        <if test="condition.status != null">
            AND status = #{condition.status}
        </if>
    </select>

    <!-- 清理过期日志 -->
    <delete id="deleteExpiredLogs">
        DELETE FROM sys_log 
        WHERE created_at &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </delete>

    <!-- 按模块统计日志数量 -->
    <select id="countByModule" resultType="int">
        SELECT COUNT(*) 
        FROM sys_log 
        WHERE module = #{module} 
        AND created_at &gt;= DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </select>

    <!-- 统计失败操作数量 -->
    <select id="countFailedOperations" resultType="int">
        SELECT COUNT(*) 
        FROM sys_log 
        WHERE status = 0 
        AND created_at &gt;= DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </select>

    <!-- 获取平均操作耗时 -->
    <select id="getAverageDuration" resultType="double">
        SELECT AVG(duration_ms) 
        FROM sys_log 
        WHERE module = #{module} 
        AND duration_ms IS NOT NULL
        AND created_at &gt;= DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </select>

</mapper>