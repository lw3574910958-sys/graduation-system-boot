# 毕业设计选题状态变更业务逻辑说明

## 1. 状态定义

### 题目状态 (TopicStatus)
- **OPEN (1)** - 开放状态：题目可供学生选择
- **REVIEWING (2)** - 审核中状态：有学生正在申请该题目
- **SELECTED (3)** - 已选状态：题目已被学生选中
- **CLOSED (4)** - 关闭状态：题目不再接受选题

### 选题状态 (SelectionStatus)
- **PENDING_REVIEW (0)** - 待审核：学生提交选题申请
- **APPROVED (1)** - 审核通过：教师同意学生选题
- **REJECTED (2)** - 审核驳回：教师拒绝学生选题
- **CONFIRMED (3)** - 已确认：学生确认选题

## 2. 状态流转规则

### 2.1 题目状态流转

```
OPEN → REVIEWING → SELECTED → CLOSED
  ↓                    ↓
CLOSED              CLOSED
```

**合法转换规则：**
- OPEN ↔ REVIEWING ↔ SELECTED → CLOSED
- CLOSED 状态不可转换
- SELECTED 只能转换为 CLOSED

### 2.2 选题状态流转

```
PENDING_REVIEW → APPROVED → CONFIRMED
      ↓              ↓
   REJECTED       (最终状态)
```

**合法转换规则：**
- PENDING_REVIEW → APPROVED/REJECTED
- APPROVED → CONFIRMED
- REJECTED 为最终状态
- CONFIRMED 为最终状态

## 3. 业务事件处理

### 3.1 学生申请选题 (applySelection)
**触发条件：** 学生提交选题申请
**处理逻辑：**
1. 验证题目是否为开放状态
2. 创建选题申请记录（状态：PENDING_REVIEW）
3. **触发题目状态变更：** 如果题目为开放状态，转为审核中状态

### 3.2 教师审核选题 (reviewSelection)
**触发条件：** 教师审核选题申请
**处理逻辑：**
1. 验证审核权限
2. 更新选题申请状态（APPROVED/REJECTED）
3. **触发题目状态变更检查：**
   - 如果通过：检查是否还有其他待处理申请
   - 如果驳回：检查是否还有其他待处理申请
   - 如无待处理申请，题目恢复为开放状态

### 3.3 学生确认选题 (confirmSelection)
**触发条件：** 学生确认已通过审核的选题
**处理逻辑：**
1. 验证确认权限和状态
2. 更新选题申请状态为 CONFIRMED
3. **触发题目状态变更：**
   - 更新题目已选人数 (+1)
   - 题目状态转为 SELECTED
   - 如达到人数上限，自动转为 CLOSED

### 3.4 取消选题申请 (cancelSelection)
**触发条件：** 学生取消未确认的选题申请
**处理逻辑：**
1. 验证取消权限和状态
2. 如为已通过状态，减少题目已选人数 (-1)
3. **触发题目状态变更检查：** 检查是否需要恢复题目状态
4. 逻辑删除选题申请记录

## 4. 自动化状态管理

### 4.1 题目状态自动更新
- **申请提交时：** OPEN → REVIEWING
- **全部审核完成时：** REVIEWING → OPEN
- **学生确认时：** REVIEWING/OPEN → SELECTED
- **达到人数上限时：** SELECTED → CLOSED

### 4.2 数据一致性保障
- 选题人数实时更新
- 状态转换合法性验证
- 缓存及时清理
- 事务性操作保证数据完整性

## 5. 异常处理机制

### 5.1 状态验证
- 非法状态转换将抛出业务异常
- 提供详细的错误信息说明

### 5.2 并发控制
- 使用数据库事务保证操作原子性
- 通过唯一约束防止重复选题

### 5.3 数据恢复
- 支持选题申请撤销
- 状态回滚机制完善

## 6. 性能优化

### 6.1 缓存策略
- 题目信息使用Redis缓存
- 状态变更时自动清理相关缓存

### 6.2 索引优化
- 关键字段建立复合索引
- 状态查询性能优化

### 6.3 查询优化
- 避免N+1查询问题
- 批量操作减少数据库交互

## 7. 监控与日志

### 7.1 关键操作日志
- 状态变更记录
- 业务操作审计
- 异常情况追踪

### 7.2 性能监控
- 状态转换耗时统计
- 系统瓶颈识别
- 优化建议生成